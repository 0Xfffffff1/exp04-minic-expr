# 5.11 函数定义

要事先创建一个用于保存返回值的局部变量（称为返回值局部变量）、
一个函数入口Label 指令和一个函数出口标签指令。
函数入口标签指令位于函数的开头，其后紧跟一个函数入口entry 指
令。
函数出口标签指令放在函数的尾部，紧跟一个函数出口指令。该出口
标签指令用于return 语句的翻译的跳转目标，保持函数只有一个出口。
函数定义的翻译后的基本格式如下所示：
declare 指令用于函数内所有变量的类型说明
函数入口标签指令优化时可删除
函数入口指令
其它IR 指令
函数出口标签指令优化时可删除
函数出口指令

## 5.11.1 函数返回值变量

在函数翻译时，如果返回的返回值类型不是void，则需要在函数的开
头申请一个返回值局部变量，用于保存函数的返回值。

## 5.11.2 函数入口指令

格式：entry
功能：函数的入口。每个函数有且只有一个。必须存在，用于表示函
数的第一条有效指令。
放置在declare 语句指令的后面，其它指令的前面。

## 5.11.3 函数出口指令

格式：exit 变量
格式：exit 常量
格式：exit
功能：函数的出口指令。每个函数有且只有一个出口指令。存在于函
数的最尾部。这里的变量一般指的是翻译时创建的返回值局部变量。

## 5.11.4 return 语句翻译

对于含有返回值的return 语句翻译，先把返回值保存到返回值局部变
量中，然后通过br 指令跳转到函数出口标签。
对于没有返回值的return 语句翻译，直接通过br 指令跳转到函数出
口标签。

## 5.11.5 函数形参处理

对于函数的形参，首先通过declare 分配与形参对应的局部变量（将
来用于在栈内分配空间），其次把原始的形参变成临时变量类型，在
entry 指令后把形参的值（临时变量）保存到对应的局部变量中。后续对
形参的所有引用修改为对应的局部变量引用。

## 5.11.6 函数翻译举例

int test(int a, int b)

{
...
return 0;
...
return 1;
}
转换为中间IR 形式：
define i32 @test(i32 %t0, i32 %t1) {
declare i32 %l2 ;返回值局部变量
declare i32 %l3 ;形参a 对应的局部变量
declare i32 %l4 ; 形参b 对应的局部变量

.L1: ; 函数入口标签指令
Entry ; 函数入口指令
%l3 = %t0 ;a 赋值给a 对应的局部变量
%l4 = %t1 ;b 赋值给b 对应的局部变量
后续所有对a 和b 的操作修改成对应的局部变量操作
...
%l2 = 0 ; return 0 的翻译
br .L1
...
%l2 = 1 ; return 1 的翻译
br .L1

.L2: ;函数出口标签
exit %l2 ; 函数出口指令
}

其中define 为关键字，函数名以@开头，要求全局唯一，后面跟C 语
言的函数名
局部变量%l2 为函数返回值在栈内分配的局部变量
局部变量%l3 为形参a 在栈内分配的局部变量
局部变量%l4 为形参b 在栈内分配的局部变量
entry 为函数的入口，将来对应函数内寄存器保存以及栈空间分配等
%l3 = %t0 对应把形参a 的值保存到栈内对应的变量%l3 上
%l4 = %t1 对应把形参b 的值保存到栈内对应的变量%l4 上
.L1 对应函数的入口Label。
.L2 对应函数的出口Label，所有的函数出口都跳转到该位置处，并设
置返回值到变量%l2 上
%l2 = 0 和br .L1 指令对应return 0，先把返回值保存到返回值局部变
量上，然后跳转到出口标签.L1 上。
exit %l2 带有返回值的退出指令。当然， %l2 变量的值也可以先暂存
到临时变量中，然后通过指令exit 临时变量也可实现同样的功能。

# 5.12 函数调用

C 语言的函数调用时函数参数的运算根据不同的编译器实现方式不同
实现也不同。本IR 规定函数实参按照自左往右运算，实参结果按自右往
左依次入栈。对于个别后端CPU，如允许通过寄存器传值，则实参结果可
按照约定进行寄存器传值，之后仍旧按自右往左依次入栈。

5.12.1 有函数值返回的函数调用
使用call 指令实现函数调用，或者借助arg 指令与call 指令完成。

例1：
e = test(c, d);
转换为
%t1 = %l1
%t2 = %l2
%t3 = call i32 @test(i32 %t1,i32 %t2)
%l3 = %t3
或者
%t3 = call i32 @test(i32 %l1,i32 %l2)
%l3 = %t3
其中%l1 代表局部变量c，%l2 代表局部变量d，%l3 代表局部变量e
%t1,%t2,%t3 为编译器内部生成的临时变量